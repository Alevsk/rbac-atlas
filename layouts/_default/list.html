{{ define "main" }}
{{ with .Content }}
<div class="index-content">{{ . }}</div>
{{ end }}
<h2>Versions</h2>
<div class="posts">
{{/* Use the current section's pages directly — no need to scan all site pages */}}
{{ $allPages := .RegularPages }}
{{ $sortedPages := sort $allPages "Params.version_order" "desc" }}

{{/* Display all versions */}}
{{ range $sortedPages }}
{{ $page := . }}
<article class="post on-list">
  <div class="title-card-wrapper">
    <h2>
      <a href="{{ $page.Permalink }}">{{ $page.Title | markdownify }}</a>
    </h2>
    {{- if $page.Params.version -}}
    <span class="post-version">{{- $page.Params.version -}}</span>
    {{- end -}}
  </div>

  {{ partial "cover.html" . }}

  <div class="post-stats">
    {{ if gt (int .Params.critical_findings) 0 }}
    <span class="stat-item risk-critical">
      <i class="fas fa-skull"></i>
      {{ .Params.critical_findings }} Critical
    </span>
    {{ end }}
    {{ if gt (int .Params.high_findings) 0 }}
    <span class="stat-item risk-high">
      <i class="fas fa-exclamation-triangle"></i>
      {{ .Params.high_findings }} High
    </span>
    {{ end }}
    {{ if gt (int .Params.medium_findings) 0 }}
    <span class="stat-item risk-medium">
      <i class="fas fa-exclamation-circle"></i>
      {{ .Params.medium_findings }} Medium
    </span>
    {{ end }}
    {{ if gt (int .Params.low_findings) 0 }}
    <span class="stat-item risk-low">
      <i class="fas fa-info-circle"></i>
      {{ .Params.low_findings }} Low
    </span>
    {{ end }}

    <span class="stat-item"><i class="fa-solid fa-robot"></i> {{ default "0" .Params.service_accounts }}</span>
    <span class="stat-item"><i class="fa-solid fa-cube"></i> {{ default "0" .Params.workloads }}</span>
    <span class="stat-item"><i class="fa-solid fa-link"></i> {{ default "0" .Params.bindings }}</span>
  </div>

  <div class="post-content">
    {{ if .Params.showFullContent }}
    {{ .Content }}
    {{ else if .Description }}
    <p>{{ .Description | markdownify }}</p>
  {{ else }}
    {{ .Summary }}
    {{ end }}
  </div>

  {{ if .Params.tags }}
  <span class="post-tags">
    {{ $tags := .Params.tags }}
    {{ $tagCount := len $tags }}
    {{ range first 3 $tags }}
    #<a href="{{ (urlize (printf "tags/%s/" . )) | absLangURL }}">{{- . -}}</a>&nbsp;
    {{ end }}
    {{ if gt $tagCount 3 }}
    (+{{ sub $tagCount 3 }} more)
    {{ end }}
  </span>
  {{ end }}

  {{ if not .Params.showFullContent }}
  <div>
    <a class="read-more button inline" href="{{ .RelPermalink }}">{{ $.Site.Params.ReadMore }} ›</a>
  </div>
  {{ end }}
</article>
{{ end }}
{{ partial "pagination.html" . }}
</div>
{{ end }}
