{{ define "main" }}
{{ with .Content }}
<div class="index-content">{{ . }}</div>
{{ end }}
<h2>Versions</h2>
<div class="posts">
  {{ $isntDefault := not (or (eq (trim $.Site.Params.contentTypeName " ") "posts") (eq (trim $.Site.Params.contentTypeName " ") "")) }}
  {{ $contentTypeName := cond $isntDefault (string $.Site.Params.contentTypeName) "posts" }}

  {{ $PageContext := . }}
  {{ if .IsHome }}
  {{ $PageContext = .Site }}
  {{ end }}

{{/* Group and sort pages by project name */}}
{{ $allPages := where $PageContext.RegularPages "Type" $contentTypeName }}

{{/* First, get unique repo/chart combinations */}}
{{ $projects := slice }}
{{ range $allPages }}
{{ $pathParts := split .File.Dir "/" }}
{{ if ge (len $pathParts) 3 }}
{{ $repoName := index $pathParts 1 }}
{{ $chartName := index $pathParts 2 }}
{{ $projects = $projects | append (printf "%s/%s" $repoName $chartName) }}
{{ end }}
{{ end }}
{{ $projects = uniq (sort $projects) }}

{{/* For each repo/chart, get all versions sorted */}}
{{ $groupedProjects := slice }}
{{ range $projects }}
{{ $pathParts := split . "/" }}
{{ $repoName := index $pathParts 0 }}
{{ $chartName := index $pathParts 1 }}
{{ $projectPages := where $allPages "File.Dir" (printf "charts/%s/%s/" $repoName $chartName) }}
{{ $sortedPages := sort $projectPages "Params.version_order" "desc" }}
{{ $groupedProjects = $groupedProjects | append (dict "name" (printf "%s/%s" $repoName $chartName) "pages" $sortedPages) }}
{{ end }}

{{/* Display projects and their versions */}}
{{ range $groupedProjects }}
{{ range .pages }}
{{ $page := . }}
<article class="post on-list">
  <div class="title-card-wrapper">
    <h2>
      <a href="{{ $page.Permalink }}">{{ $page.Title | markdownify }}</a>
    </h2>
    {{- if $page.Params.version -}}
    <span class="post-version">{{- $page.Params.version -}}</span>
    {{- end -}}
  </div>

  {{ partial "cover.html" . }}

  <div class="post-stats">
    {{ if gt (int .Params.critical_findings) 0 }}
    <span class="stat-item risk-critical">
      <i class="fas fa-skull"></i>
      {{ .Params.critical_findings }} Critical
    </span>
    {{ end }}
    {{ if gt (int .Params.high_findings) 0 }}
    <span class="stat-item risk-high">
      <i class="fas fa-exclamation-triangle"></i>
      {{ .Params.high_findings }} High
    </span>
    {{ end }}
    {{ if gt (int .Params.medium_findings) 0 }}
    <span class="stat-item risk-medium">
      <i class="fas fa-exclamation-circle"></i>
      {{ .Params.medium_findings }} Medium
    </span>
    {{ end }}
    {{ if gt (int .Params.low_findings) 0 }}
    <span class="stat-item risk-low">
      <i class="fas fa-info-circle"></i>
      {{ .Params.low_findings }} Low
    </span>
    {{ end }}

    <span class="stat-item"><i class="fa-solid fa-robot"></i> {{ default "0" .Params.service_accounts }}</span>
    <span class="stat-item"><i class="fa-solid fa-cube"></i> {{ default "0" .Params.workloads }}</span>
    <span class="stat-item"><i class="fa-solid fa-link"></i> {{ default "0" .Params.bindings }}</span>
  </div>

  <div class="post-content">
    {{ if .Params.showFullContent }}
    {{ .Content }}
    {{ else if .Description }}
    <p>{{ .Description | markdownify }}</p>
  {{ else }}
    {{ .Summary }}
    {{ end }}
  </div>

  {{ if .Params.tags }}
  <span class="post-tags">
    {{ $tags := .Params.tags }}
    {{ $tagCount := len $tags }}
    {{ range first 3 $tags }}
    #<a href="{{ (urlize (printf "tags/%s/" . )) | absLangURL }}">{{- . -}}</a>&nbsp;
    {{ end }}
    {{ if gt $tagCount 3 }}
    (+{{ sub $tagCount 3 }} more)
    {{ end }}
  </span>
  {{ end }}

  {{ if not .Params.showFullContent }}
  <div>
    <a class="read-more button inline" href="{{ .RelPermalink }}">{{ $.Site.Params.ReadMore }} â€º</a>
  </div>
  {{ end }}
</article>
{{ end }}
{{ end }}
{{ partial "pagination.html" . }}
</div>
{{ end }}
